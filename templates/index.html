<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    form { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; }
    label { display: block; margin-top: 10px; }
    input, select { padding: 6px; width: 100%; max-width: 420px; }
    button { margin-top: 15px; padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #004c99; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    .count { margin-top: 10px; font-weight: bold; }
    .row-actions form { display:inline; }
    .row-actions a { display:inline-block; margin-right:6px; background:#777; color:#fff; padding:6px 10px; border-radius:5px; text-decoration:none; }
    .row-actions a:hover { background:#555; }
    .tip { color:#555; font-size:12px; }
    .admin-link { margin-bottom:10px; }
    .filters { margin-top: 10px; margin-bottom: 10px; }
    .filters label { display:inline-block; margin-right:10px; }
  </style>
  <script>
    function toggleOutro(sel){
      var outroWrap = document.getElementById('outro-wrap');
      if(sel.value === '__OUTRO__'){ outroWrap.style.display='block'; }
      else { outroWrap.style.display='none'; }
    }
  </script>
</head>
<body>
  <h1>{{ title }}</h1>

  {% if mode == "admin" %}
    <p class="admin-link">üîß <a href="{{ url_for('fornecedores_admin', pin=pin) }}">Gerenciar fornecedores (admin)</a></p>
  {% endif %}

  {% if mode == "denied" %}
    <p style="color:red;">Acesso negado.</p>
  {% else %}
    <!-- Formul√°rio de cadastro -->
    <form method="post">
      {% if not loja_lock %}
        <label>Loja:
          <select name="loja" required>
            <option value="">Selecione</option>
            {% for l in lojas %}<option value="{{ l }}">{{ l }}</option>{% endfor %}
          </select>
        </label>
      {% else %}
        <input type="hidden" name="loja" value="{{ loja_lock }}">
        <p><b>Loja:</b> {{ loja_lock }}</p>
      {% endif %}

      <label>Fornecedor/Empresa:
        <select name="empresa_sel" onchange="toggleOutro(this)">
          <option value="">Selecione</option>
          {% for f in fornecedores %}<option value="{{ f }}">{{ f }}</option>{% endfor %}
          <option value="__OUTRO__">Outro (digitar)‚Ä¶</option>
        </select>
        <div id="outro-wrap" style="display:none; margin-top:6px;">
          <input type="text" name="empresa_outro" placeholder="Digite o nome do fornecedor">
          <div class="tip">Dica: escreva o nome completo para padronizar os relat√≥rios.</div>
        </div>
      </label>

      <label>Funcion√°rio:
        <input type="text" name="funcionario" required>
      </label>

      <label>Data do servi√ßo:
        <input type="date" name="data_servico" required>
      </label>
      <label>Hora do servi√ßo:
        <input type="time" name="hora_servico" required>
      </label>

      <label>Prazo do pr√≥ximo servi√ßo:
        <select name="prazo">
          <option>1 m√™s</option><option>2 meses</option><option>3 meses</option>
        </select>
      </label>

      <button type="submit">Salvar</button>
    </form>

    <div class="count">Total de registros: {{ count }}</div>

    <!-- Filtros por per√≠odo -->
    <form method="get" class="filters">
      {% if loja_lock %}
        <input type="hidden" name="loja" value="{{ loja_lock }}">
        <input type="hidden" name="pin" value="{{ pin }}">
      {% endif %}
      <label>De: <input type="date" name="inicio" value="{{ filtro_inicio }}"></label>
      <label>At√©: <input type="date" name="fim" value="{{ filtro_fim }}"></label>
      <button type="submit">Filtrar</button>
      <a href="{{ url_for('index', loja=loja_lock, pin=pin) }}">Limpar filtro</a>
    </form>

    <!-- Exporta√ß√µes -->
    <p>
      <a href="{{ url_for('download_csv', loja=loja_lock, pin=pin, inicio=filtro_inicio, fim=filtro_fim) }}">üì• Baixar CSV</a> |
      <a href="{{ url_for('download_pdf', loja=loja_lock, pin=pin, inicio=filtro_inicio, fim=filtro_fim) }}">üìÑ Baixar PDF</a>
    </p>

    <!-- Tabela -->
    <table>
      <thead>
        <tr>
          <th>Loja</th><th>Empresa</th><th>Funcion√°rio</th><th>Data</th><th>Hora</th><th>Prazo</th><th>Pr√≥xima Data</th><th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.loja }}</td>
          <td>{{ r.empresa }}</td>
          <td>{{ r.funcionario }}</td>
          <td>{{ r.data_servico }}</td>
          <td>{{ r.hora_servico }}</td>
          <td>{{ r.prazo }}</td>
          <td>{{ r.proxima_data }}</td>
          <td class="row-actions">
            <a href="{{ url_for('edit', idx=loop.index0, loja=loja_lock, pin=pin) }}">Editar</a>
            <form method="post" action="{{ url_for('delete', idx=loop.index0, loja=loja_lock, pin=pin) }}" onsubmit="return confirm('Remover este registro?');">
              <button type="submit" style="background:#cc0000">Remover</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="8" class="tip">Nenhum registro</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</body>
</html>
